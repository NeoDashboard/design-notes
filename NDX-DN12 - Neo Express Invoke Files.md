<!-- markdownlint-enable -->
# NDX-DN12 - Neo Express Contract Invoke File Specification

- Author: Harry Pierson (harrypierson@ngd.neo.org)
- Status: Draft

## Abstract

This design note describes the contract invocation file format used by v2 of 
[neo-express](https://github.com/neo-project/neo-express) (unreleased). 

## Current Status

neo-express master branch (unreleased v2.0) supports the format described in this note
for the `contract invoke` command. As of right now, contract invocation files must be 
written by hand. 

## Overview

In neo-express v1, the `contract invoke` command accepted contract parameter information
on the command line. This turned out to be unwieldy for anything but the simplest contract
signatures. For v2, neo-express is changing to storing contract invocation information in 
a separate file, which is passed by path to the `contract invoke` command. 

There are several advantages of using a invoke file instead of the command line:

* invoke files can be checked into source control
* invoke files can handle arbitratily complex sets of arguments, including UTXO information
* invoke files can be generated by tools such as [Visual DevTracker](https://github.com/neo-project/neo-visual-tracker)

This document describes the initial format of Neo contract invoke files. Note, this format
is incomplete and expected to evolve as we get closer to the neo-express v2.0 release. These
changes are expected to be additive - which is to say everything in this document is expected
to be implemented as specified, but optional additions will likely be made. However, due to the 
draft nature of this design note, this is not a guarantee but rather an expectation of how
things will evolve.

> Note, this design note is primarily focused on Neo v2. It is likely this format will evolve 
> for Neo v3. Those differences will be documented in their own section in the future.

## neo-invoke File Format

A neo-invoke file is a serialized JSON object that contains the information needed to invoke
a Neo smart contract. The file can have any extension, though it typically uses `.neo-invoke.json`
to both indicate its usage as well as enable JSON syntax highlighting in tools.

> Note, what follows is a non-normative description of the neo-invoke JSON format. For a normative
> specification of the format, please see the [JSON Schema file](neo-invoke-schema.json);

A neo-invoke JSON object has two required properties: `hash` and `arguments`:

* `hash` is a hex-encoded script hash. This is the hash of the contract to be invoked.
* `args` is an array of contract parameters to be passed to the contact via the invoke script

The core neo ContractParameter type's
[FromJson method](https://github.com/neo-project/neo/blob/master-2.x/neo/SmartContract/ContractParameter.cs#L58)
expects a contract parameters to be encoded like this:

> Note, these types are defined in TypeScript for readability.
> There is no requirement that this format be implemented in TypeScript.

``` typescript
// InteropInterface and Void ContractParameterTypes can not be specified in JSON
enum ContractParameterType {
    Signature,
    Boolean,
    Integer,
    Hash160,
    Hash256,
    ByteArray,
    PublicKey,
    String,
    Array,
    Map,
}

interface ContractParameter {
    type: ContractParameterType,
    value: boolean | string | ContractParameter[] | {key: ContractParameter, value: ContractParameter}[]
}
```

The specifics of the JSON encoded value field vary by parameter type:

* Boolean parameter values encoded as JSON boolean
* String parameter values encoded as JSON string
* Signature and ByteArray parameter values are encoded as a hex-encoded JSON string
* Integer, Hash160/256, Public Key are encoded as serialized JSON string of the corresponding type (BigInteger, UInt160/256, ECPoint)
* Array parameters are encoded as JSON array of encoded contract parameters
* Map parameter are encoded as a JSON array of objects, each with a "key" and "value" property containing an encoded contract parameter

While this encoding is complete and deterministic, it is also verbose. For example, here is the an
example neo-invoke file for invoking the register operation of the Domain Smart Contract example
using the standard contract parameter encoding:

``` json
{
    "hash": "0xc0dee90a1ce8fbb94169608907e5986a6ce909e7",
    "args": [
        {
            "type": "String",
            "value": "register"
        },
        {
            "type": "Array",
            "value": [
                {
                    "type": "String",
                    "value": "neo.org"
                },
                {
                    "type": "Hash160",
                    "value": "7f513a2129dd800e1db8c2a57bc0873a021c9b7f"
                }
            ]
        }
    ]
}
```

To reduce verbosity and provide a better experience for developers that have to
author contract parameter JSON by hand, Neo-express uses additional, compact
encodings of Contract Parameters.

In cases where there is a direct correlation of JSON type to Contract Parameter type, the
JSON type can be used directly instead of the more verbose type qualified format. The following
JSON types are treated as the corresponding Contract parameter type:

* Boolean
* Integer
  - Note, non-integer JSON numbers are not valid contract parameters
* String
* Array

Additionally, direct encoded strings can use special prefixes to indicate other contract
parameter types

* Direct encoded strings with a '0x' prefix are treated as a hex encoded ByteArray 
* Direct encoded strings with a '@A' prefix are readed as a base68 encoded Hash160 value (i.e. Neo wallet addresses)
  * For Neo v3, the prefix will be '@N'

These additional encodings significantly simplify the sample invoke file from above:

``` json
{
    "hash": "0xc0dee90a1ce8fbb94169608907e5986a6ce909e7",
    "args": [
        "register",                               // direct encoded string
        [                                         // direct encoded array
            "neo.org",
            "@ANxbzd4FuNr1BBMJX2ZixSzFKFWeFCReAb" // base56 encoded Hash160
        ]
    ]
}
```
